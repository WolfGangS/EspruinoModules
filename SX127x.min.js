function d(a){this.spi=a.spi;this.cs=a.cs;(this.rst=a.rst)&&digitalPulse(this.rst,0,1);setTimeout(this.init.bind(this),7);this.options={};this.state=""}d.prototype.w=function(a,b){if("number"!=typeof a)throw"!";if("number"==typeof b&&isNaN(b))throw"!";this.spi.write(a|128,b,this.cs)};d.prototype.r=function(a,b){if("number"!=typeof a)throw"!";if(b){var c=new Uint8Array(b+1);c[0]=a&127;c=this.spi.send(c,this.cs);return new Uint8Array(c.buffer,1)}return this.spi.send([a&127,0],this.cs)[1]};
d.prototype.mask=function(a,b,c){this.w(a,this.r(a)&b|c)};d.prototype.setOpMode=function(a){this.mask(1,248,a)};d.prototype.init=function(){var a=this.r(66);if(0===a||255==a)throw Error("Radio not found!");this.setOpMode(0);this.mask(1,127,128);this.w(64,0);this.w(65,0);this.w(35,64)};d.prototype.rx=function(a){this.rxCallback=a;this.options.iqInverted?(this.mask(51,190,65),this.w(59,25)):(this.mask(51,190,1),this.w(59,29));this.options.freqHopOn?(this.w(17,29),this.mask(64,51,0)):(this.w(17,31),
this.mask(64,63,0));this.w(15,0);this.w(13,0);this.state="RX_RUNNING";this.setOpMode(this.options.rxContinuous?5:6)};d.prototype.tx=function(){this.options.freqHopOn?(this.w(17,245),this.mask(64,51,64)):(this.w(17,247),this.mask(64,63,64));this.state="TX_RUNNING";this.setOpMode(3)};d.prototype.sleep=function(){this.setOpMode(0);this.state="IDLE"};d.prototype.standby=function(){this.setOpMode(1);this.state="IDLE"};d.prototype.send=function(a,b){this.txCallback=b;this.options.iqInverted?(this.mask(51,
190,0),this.w(59,25)):(this.mask(51,190,1),this.w(59,29));this.w(34,a.length);this.w(14,0);this.w(13,0);var c=function(){this.w(0,a);this.tx()}.bind(this);0==(this.r(1)&-249)?(this.standby(),setTimeout(c,1)):c()};d.prototype.getStatus=function(){var a=this.r(18);return{rxDone:!!(a&64),rxTimeout:!!(a&128),crcError:!!(a&32),validHeader:!!(a&16),txDone:!!(a&8),cadDone:!!(a&4),changedChannel:!!(a&2),cadDetected:!!(a&1)}};d.prototype.onIRQ=function(){var a=this.r(18);if(a&64){this.w(18,64);if(a&32){this.w(18,
32);this.options.rxContinuous||(this.state="IDLE");this.rxCallback&&this.rxCallback("RxError");return}var b={};b.snr=this.r(25);b.rssi=this.r(26);var c=this.r(19);b.data=this.r(0,c);this.options.rxContinuous||(this.state="IDLE");this.rxCallback&&this.rxCallback(null,b)}a&8&&(this.w(18,8),this.txCallback&&this.txCallback())};d.prototype.commonSetConfig=function(a){a.freq=a.freq||868E6;var b=0|a.freq/61.03515625;this.w(6,b>>16&255);this.w(7,b>>8&255);this.w(8,b&255);a.power=a.power||14;a.bandwidth|=
0;if(2<a.bandwidth)throw Error("When using LoRa modem only bandwidths 125, 250 and 500 kHz are supported");a.bandwidth+=7;a.datarate=a.datarate||7;a.datarate=E.clip(a.datarate,6,12);this.LowDatarateOptimize=7==a.bandwidth&&(11==a.datarate||12==a.datarate)||8==a.bandwidth&&12==a.datarate?1:0;a.coderate=a.coderate||1;a.preambleLen=a.preambleLen||8;a.fixLen|=0;a.crcOn|=0;a.freqHopOn|=0;a.iqInverted|=0;a.rxContinuous|=0;a.symbTimeout=a.symbTimeout||5;for(var c in a)this.options[c]=a[c];this.freqHopOn&&
(a.hopPeriod=a.hopPeriod||4,this.mask(68,127,128),this.w(36,a.hopPeriod));this.mask(29,0,a.bandwidth<<4|a.coderate<<1|a.fixLen);this.mask(38,247,this.LowDatarateOptimize<<3);this.mask(49,248,6==a.datarate?5:3);this.w(55,6==a.datarate?12:10);return a};d.prototype.setRxConfig=function(a){a=this.commonSetConfig(a);this.mask(30,8,a.datarate<<4|a.crcOn<<2|a.symbTimeout>>8&-253);this.w(31,a.symbTimeout&255);this.w(32,a.preambleLen>>8&255);this.w(33,a.preambleLen&255);a.fixLen&&this.w(34,a.payloadLen)};
d.prototype.setTxConfig=function(a){a=this.commonSetConfig(a);var b=this.r(9),c=this.r(77);b=(b&127|0)&143|112;b&128?(c=17<a.power?c&248|7:c&248|4,c&7?(a.power=E.clip(a.power,5,20),b=b&240|a.power-5&15):(a.power=E.clip(a.power,2,17),b=b&240|a.power-2&15)):(a.power=E.clip(a.power,-1,14),b=b&240|a.power+1&15);this.w(9,b);this.w(77,c);this.mask(30,11,a.datarate<<4|a.crcOn<<2);this.w(32,preambleLen>>8&255);this.w(33,preambleLen&255)};exports.connect=function(a){return new d(a)}