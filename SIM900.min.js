function m(a){var d=a.indexOf(":\r\n");if(0>d)return a;var b=a.substring(9,d).split(",");b[1]|=0;var c=a.length-(d+3);if(c>=b[1])return f[b[0]]+=a.substr(d+3,b[1]),a.substr(d+b[1]+3);f[b[0]]+=a.substr(d+3,c);return"+D,"+b[0]+","+(b[1]-c)+":"}function n(a){var d=a.indexOf(":");if(0>d)return a;var b=a.substring(3,d).split(",");b[1]|=0;var c=a.length-(d+1);if(c>=b[1])return f[b[0]]+=a.substr(d+1,b[1]),a.substr(d+b[1]+1);f[b[0]]+=a.substr(d+1,c);return"+D,"+b[0]+","+(b[1]-c)+":"}var e,g=[],
f=["","","","",""],l,h=!1,p={create:function(a,d){if(void 0===a){var b=5;g[b]="Wait";f[b]="";e.cmd("AT+CIPSERVER=1,"+d+"\r\n",1E4,function(a){if("OK"==a)g[b]=!0;else throw g[b]=void 0,Error("CIPSERVER failed");});return 5}for(b=0;void 0!==g[b];)b++;if(5<=b)throw Error("No free sockets.");g[b]="Wait";f[b]="";e.cmd("AT+CIPSTART="+b+',"TCP",'+JSON.stringify(a)+","+d+"\r\n",1E4,function(a){if("OK"==a)e.registerLine(b+", CONNECT OK",function(){e.unregisterLine(b+", CONNECT OK");e.unregisterLine(b+", CONNECT FAIL");
g[b]=!0;return""}),e.registerLine(b+", CONNECT FAIL",function(){e.unregisterLine(b+", CONNECT FAIL");e.unregisterLine(b+", CONNECT OK");e.unregisterLine(b+", CLOSED");g[b]=void 0;return""}),e.registerLine(b+", CLOSED",function(){e.unregisterLine(b+", CLOSED");var a=b;e.unregister(">");e.unregisterLine(a+", SEND OK");e.unregisterLine(a+", SEND FAIL");g[b]=void 0;h=!1;return""});else return g[b]=void 0,""});return b},close:function(a){g[a]&&e.cmd("AT+CIPCLOSE="+a+",1\r\n",1E3,function(){g[a]=void 0})},
accept:function(a){for(a=0;5>a;a++)if(f[a]&&void 0===g[a])return g[a]=!0,a;return-1},recv:function(a,d){if(f[a]){if(f[a].length>d){var b=f[a].substr(0,d);f[a]=f[a].substr(d)}else b=f[a],f[a]="";return b}return g[a]?"":-1},send:function(a,d){if(h||e.isBusy()||"Wait"==g[a])return 0;if(!g[a])return-1;h=!0;e.register(">",function(){e.unregister(">");e.write(d);return""});e.registerLine(a+", SEND OK",function(){e.unregisterLine(a+", SEND OK");e.unregisterLine(a+", SEND FAIL");h=!1;return""});e.registerLine(a+
", SEND FAIL",function(){e.unregisterLine(a+", SEND OK");e.unregisterLine(a+", SEND FAIL");h=!1;return-1});e.write("AT+CIPSEND="+a+","+d.length+"\r\n");return d.length}},k={receiveHandler:m,debug:function(){return{socks:g,sockData:f}},init:function(a){var d=0,b=function(c){switch(d){case 0:if("IIIIATE0"===c||c==="IIII"+String.fromCharCode(255)+"ATE0"||"ATE0"===c)return b;"OK"===c?(d=1,e.cmd("AT+CPIN?\r\n",1E3,b)):c&&a("Error in ATE0: "+c);break;case 1:if("+CPIN: READY"===c)return b;"OK"===c?(d=2,
e.cmd("AT+CGATT=1\r\n",1E3,b)):c&&a("Error in CPIN: "+c);break;case 2:"OK"===c?(d=3,e.cmd("AT+CIPSHUT\r\n",1E3,b)):c&&a("Error in CGATT: "+c);break;case 3:"SHUT OK"===c?(d=4,e.cmd("AT+CIPSTATUS\r\n",1E3,b)):c&&a("Error in CIPSHUT: "+c);break;case 4:if("OK"===c)return b;"STATE: IP INITIAL"===c?(d=5,e.cmd("AT+CIPMUX=1\r\n",1E3,b)):c&&a("Error in CIPSTATUS: "+c);break;case 5:if(c&&"C: "==c.substr(0,3))return b;"OK"===c?(d=6,e.cmd("AT+CIPHEAD=1\r\n",1E3,b)):c&&a("Error in CIPMUX: "+c);break;case 6:if("OK"===
c)return b;c?a("Error in CIPHEAD: "+c):a(null)}};e.cmd("ATE0\r\n",3E3,b)},reset:function(a){if(!l)return k.init(a);digitalPulse(l,!1,200);setTimeout(function(){k.init(a)},15E3)},getVersion:function(a){e.cmd("AT+GMR\r\n",1E3,function(d){a(null,d)})},connect:function(a,d,b,c){var f=0,g=function(a){switch(f){case 0:"OK"===a?(f=1,e.cmd("AT+CIICR\r\n",2E3,g)):a&&c("Error in "+f+": "+a);break;case 1:if("OK"===a)return g;a?c("Error in "+f+": "+a):c(null)}};e.cmd('AT+CSTT="'+a+'", "'+d+'", "'+b+'"\r\n',1E3,
g)},getIP:function(a){var d,b=function(c){if(c&&"ERROR"!=c&&"OK"!=c)return d=c,b;"ERROR"===c?a("CIFSR Error"):c||a(null,d)};e.cmd("AT+CIFSR\r\n",2E3,b)}};exports.connect=function(a,d,b){l=d;k.at=e=require("AT").connect(a);require("NetworkJS").create(p);e.register("+RECEIVE",m);e.register("+D",n);k.reset(b);return k}