function d(b,c){this.flash=c?c:require("Flash");if(b)this.addr=b;else if(void 0!==this.flash.getFree){var a=this.flash.getFree();if(a.length)this.addr=a[0].addr;else throw"No free flash memory found";}else{a=process.memory();if(!a.flash_start||!a.flash_length)throw"process.memory() didn't contain information about flash memory";this.addr=a.flash_start+a.flash_length}a=this.flash.getPage(this.addr);if(!a)throw"Couldn't find flash page";this.addr=a.addr;this.endAddr=a.addr+a.length}d.prototype.getAddr=
function(b){for(var c=this.addr,a=this.flash.read(4,c),d=-1;255!=a[3]&&c<this.endAddr;)a[0]==b&&(d=c),c+=(a[1]|a[2]<<8)+7&-4,a=this.flash.read(4,c);return{addr:d,end:c}};d.prototype.read=function(b){b=this.getAddr(b).addr;if(!(0>b))return key=this.flash.read(4,b),this.flash.read(key[1]|key[2]<<8,b+4)};d.prototype.readMem=function(b){b=this.getAddr(b).addr;if(!(0>b))return key=this.flash.read(4,b),E.memoryArea(b+4,key[1]|key[2]<<8)};d.prototype.readAll=function(){for(var b=[],c=this.addr,a=this.flash.read(4,
c);255!=a[3]&&c<this.endAddr;){var d=a[1]|a[2]<<8;d&&(b[a[0]]=this.flash.read(d,c+4));c+=d+7&-4;a=this.flash.read(4,c)}return b};d.prototype._write=function(b,c,a){this.flash.write(new Uint8Array([c,a.length,a.length>>8,0]),b);b+=4;4!=a.length&&(c=new Uint8Array(a.length+3&-4),c.set(a),a=c);a.length&&this.flash.write(a,b);return b+a.length};d.prototype.write=function(b,c){c=E.toUint8Array(c);var a=this.getAddr(b);if(0<=a.addr&&(key=this.flash.read(4,a.addr),this.flash.read(key[1]|key[2]<<8,a.addr+
4)==c))return;if(a.end+c.length+4>=this.endAddr&&(a.end=this.cleanup(),a.end+c.length+4>=this.endAddr))throw"Not enough memory!";this._write(a.end,b,c)};d.prototype.cleanup=function(){var b=this.readAll();this.flash.erasePage(this.addr);var c=this.addr,a;for(a in b)void 0!==b[a]&&(c=this._write(c,a,b[a]));return c};d.prototype.erase=function(){this.flash.erasePage(this.addr)};exports=d