function v(a){g[a]?p?(d&&console.log("at register currenly programmed"),setTimeout(function(){console.log("closing later...");v(a)},1500)):b.isBusy()?(d&&console.log("AT busy"),setTimeout(function(){console.log("closing again...");v(a)},1500)):(d&&console.log("sending AT+QICLOSE for socket "+a),b.cmd("AT+QICLOSE="+a+"\r\n",1E3,function(e){d&&console.log(e);"OK"==e?(d&&console.log("socket "+a+" is closed"),g[a]=void 0):(d&&console.log("cannot close socket now"+a+",error="+e),g[a]="tobeclosed")})):
d&&console.log("socket already closed")}function z(a){var e=a.indexOf("\r\n");if(0>e)return a;var c=a.substring(15,e).split(",");c[1]|=0;var d=a.length-(e+2);if(d>=c[1])return l[c[0]]+=a.substr(e+2,c[1]),a.substr(e+c[1]+3);l[c[0]]+=a.substr(e+2,d);return"+D,"+c[0]+","+(c[1]-d)+":"}function B(a){var e=a.indexOf(":");if(0>e)return a;var c=a.substring(3,e).split(",");c[1]|=0;var d=a.length-(e+1);if(d>=c[1])return l[c[0]]+=a.substr(e+1,c[1]),a.substr(e+c[1]+1);l[c[0]]+=a.substr(e+1,d);return"+D,"+c[0]+
","+(c[1]-d)+":"}function C(a){d&&console.log("closehandler:"+a);var e=a.indexOf("\r\n");if(0>e&&(d&&console.log("not enough data "+a),e=a.indexOf("\r"),0>e))return d&&console.log("definitively not enough data "+a),a;a=a.substring(0,e).split(",");a[1]|=0;v(a[1]);return""}function D(a){d&&console.log("pdpdeacthandler:"+a);b.cmd("AT+QIDEACT=1\r\n",1E3,function(a){d&&console.log(a);for(a=0;12>a;a++)g[a]=void 0,l[a]=""})}function F(a){d&&console.log("QindHandler in: "+a);return""}function G(a){d&&console.log("QusimHandler in: "+
a);return""}function H(a){d&&console.log("CfunHandler in: "+a);return""}function I(a){d&&console.log("RdyHandler in: "+a);return""}var b,p=!1,g=[],l="           ".split(" "),q,w,u,x,A=!1,m={},r="",y=!1,d=!1,J={create:function(a,e){var c=0;if(void 0===a){d&&console.log("WARNING: this has not been fully ported for UGxx");for(c=11;void 0!==g[c];)c--;if(0>c)throw Error("No free sockets.");g[c]="Wait";l[c]="";b.cmd("AT+QIOPEN=1,"+c+',"TCP LISTENER","127.0.0.1",0,'+e+",0\r\n",1E4,function(a){if("OK"==a)g[c]=
!0;else throw g[c]=void 0,Error("CREATE SERVER failed");});return 12}for(;void 0!==g[c];)c++;12<=c&&(d&&console.log("WORKAROUND closing the socket: "+c),c--,b.cmd("AT+QICLOSE="+c+"\r\n",1E3,function(a){d&&console.log(a);g[c]=void 0}));g[c]="Wait";l[c]="";d&&console.log("AT+QIOPEN=1,"+c+',"TCP",'+JSON.stringify(a)+","+e+",0,1");b.cmd("AT+QIOPEN=1,"+c+',"TCP",'+JSON.stringify(a)+","+e+",0,1\r\n",15E4,function t(a){if("OK"==a)return d&&console.log("AT+QIOPEN OK"),t;a=="+QIOPEN: "+c+",0"?(d&&console.log(a),
d&&console.log("AT+QIOPEN completed with socket: "+c),g[c]=!0):a=="+QIOPEN: "+c+",565"?(d&&console.log("AT+QIOPEN failure DNS parse failed..."),g[c]="tobeclosed"):a=="+QIOPEN: "+c+",566"?(d&&console.log("AT+QIOPEN failure could not connect socket ..."),g[c]="tobeclosed"):a=="+QIOPEN: "+c+",563"?(d&&console.log("AT+QIOPEN socket identity has been used..., socket is:"+c),g[c]=!0):(d&&console.log("AT+QIOPEN failed on socket:"+c),d&&b.cmd("AT+QIGETERROR\r\n",1E3,function(a){d&&console.log(a)}),g[c]="tobeclosed");
return""});return c},close:function(a){d&&console.log("(local) Closing of the socket: "+a);v(a)},accept:function(a){d&&console.log("Accept Socket",a);for(a=0;12>a;a++)if(l[a]&&void 0===g[a])return g[a]=!0,a;return-1},recv:function(a,e){if(b.isBusy()||"Wait"==g[a])return"";if(l[a]){if(l[a].length>e){var c=l[a].substr(0,e);l[a]=l[a].substr(e)}else c=l[a],l[a]="";return c}return g[a]&&"tobeclosed"!=g[a]?"":-1},send:function(a,e){if(p||b.isBusy()||"Wait"==g[a])return 0;if("tobeclosed"==g[a]||!g[a])return-1;
if(1460<e.length)return d&&console.log("data too big"),-1;p=!0;var c=setTimeout(function(){console.log("Abort waiting prompt (for sending data)");p=!1;b.unregister(">")},1E3);b.register(">",function(){d&&console.log("Prompt coming, sending data ...");b.unregister(">");clearTimeout(c);b.write(e);return""});var k=setTimeout(function(){console.log("Abort waiting modem response (sending data)");p=!1;b.unregisterLine("SEND OK");b.unregisterLine("SEND FAIL");b.unregisterLine("ERROR")},1E3);b.registerLine("SEND OK",
function(){d&&console.log("SEND OK");b.unregisterLine("SEND OK");b.unregisterLine("SEND FAIL");b.unregisterLine("ERROR");clearTimeout(k);p=!1;return""});b.registerLine("SEND FAIL",function(){d&&console.log("SEND FAIL");b.unregisterLine("SEND OK");b.unregisterLine("SEND FAIL");b.unregisterLine("ERROR");clearTimeout(k);p=!1;"tobeclosed"==g[a];return""});b.registerLine("ERROR",function(){d&&console.log("ERROR communication");b.unregisterLine("SEND OK");b.unregisterLine("SEND FAIL");b.unregisterLine("ERROR");
clearTimeout(k);p=!1;"tobeclosed"==g[a];return""});b.write("AT+QISEND="+a+","+e.length+"\r\n");return e.length}},n={receiveHandler:z,debug:function(a,e){d=void 0===a?!1:a;(void 0===e?0:e)&&b.debug();return{socks:g,sockData:l}},init:function(a){var e=0,c=0,k=0,g=!1,h=function(f){switch(k){case 0:d&&console.log("debug AT_SYNCHRO :"+f);if("AT"===f)return h;"OK"===f?(console.log("AT passed"),n.emit("AT_Passed"),k=2,b.cmd('AT+QURCCFG="urcport","uart1"\r\n',1E3,h)):(k=0,e++,d&&console.log("AT sync failed: "+
f),10>=e?setTimeout(function(){b.cmd("AT\r\n",1E3,h)},500):(d&&console.log("No OK return after 10 times"),d&&console.log("Check the module is power on"),a("Error in AT sync: "+f)));break;case 2:d&&console.log("debug AT_URC_PORT_CONFIG : "+f);if("AT+QURCCFG"===f.substr(0,10))return h;"OK"===f?(d&&console.log("URC port config OK - use uart1"),k=1,b.cmd("ATV1\r\n",1E3,h)):f&&a("Error in config URC port: "+f);void 0===f&&a("AT+QURCCFG time-out !!!");break;case 1:d&&console.log("debug AT_RSP_FORMAT :"+
f);if("OK"===f)k=3,b.cmd("ATE0\r\n",1E3,h);else{if("ATV1"===f)return h;f&&a("Error in ATV1: "+f)}void 0===f&&(d&&console.log("Cannot set TA response format"),a("ATV1 time-out !!!"));break;case 3:d&&console.log("debug AT_ECHO_OFF :"+f);if("IIIIATE0"===f||f==="IIII"+String.fromCharCode(255)+"ATE0"||"ATE0"===f)return h;"OK"===f?(d&&console.log("ATE0 passed: "+f),A?(k=11,b.cmd("AT+IFC=2,2\r\n",2E3,h)):(k=4,b.cmd("AT+CPIN?\r\n",5E3,h))):"atE0"===f?(d&&console.log("UGxx/ECxx returns "+f),k=4,b.cmd("AT+CPIN?\r\n",
5E3,h)):f&&a("Error in ATE0: "+f);void 0===f&&(d&&console.log("ATE0 time-out !!!"),k=4,b.cmd("AT+CPIN?\r\n",5E3,h));break;case 11:d&&console.log("debug AT_HW_FLOW_CONTROL :"+f);"OK"===f?d&&console.log("HW flow control establismnent succeeded"):a("HW flow control establismnent failed");k=4;b.cmd("AT+CPIN?\r\n",5E3,h);break;case 4:d&&console.log("debug AT_CPIN :"+f);if("+CPIN: READY"===f)return h;"OK"===f?(k=5,b.cmd("AT+QCCID\r\n",2E3,h)):f&&a("Error in CPIN: "+f);void 0===f&&(d&&console.log("SIM cannot be read, SIM is either protected, blocked or not accessible"),
a("AT+CPIN time-out !!!"));break;case 5:d&&console.log("debug AT_SHOW_SIM_ID :"+f);if(f&&"+QCCID:"==f.substr(0,7))return d&&console.log("SIM ID :"+f),h;"OK"===f?(k=6,b.cmd("AT+CSQ\r\n",2E3,h)):f&&a("Error in QCCID: "+f);void 0===f&&a("AT+QCCID time-out !!!");break;case 6:d&&console.log("debug AT_QUERY_SIGNAL_QUALITY :"+f);if(f&&"+CSQ:"==f.substr(0,5))return f&&"+CSQ: 99,99"==f.substr(0,11)?(d&&console.log("Signal not known or not detectable yet"),g=!1):(g=!0,d&&console.log("Info signal :"+f)),h;"OK"===
f?g?(k=7,d&&console.log("PS attacment is starting. It may take until a minute, please wait ... "),b.cmd("AT+CGATT=1\r\n",75E3,h)):setTimeout(function(){b.cmd("AT+CSQ\r\n",2E3,h)},500):f&&a("Error in QCCID: "+f);void 0===f&&a("AT+CSQ time-out !!!");break;case 7:d&&console.log("debug AT_PS_ATTACMENT :"+f);"OK"===f?(console.log("PS attachment succeeded"),k=10,b.cmd("AT+COPS?\r\n",2E4,h)):f&&(c+=1,d&&console.log("Error in CGATT: "+f+" - retry: "+c),1==c?(d&&console.log("Trying an automatic registration first. It may take until 3 minutes, please wait ..."),
k=8,setTimeout(function(){b.cmd("AT+COPS=0\r\n",18E4,h)},2E3)):4>c?(d&&console.log("Retrying CGATT"),k=7,d&&console.log("PS attacment is attempting again. It may take until a minute, please wait ... "),setTimeout(function(){b.cmd("AT+CGATT=1\r\n",75E3,h)},2E3*c)):a("Unrecoverable Error, PS attachment failed: "+f));break;case 8:d&&console.log("COPS returns: "+f);k=9;setTimeout(function(){b.cmd("AT+COPS?\r\n",1E4,h)},5E3);break;case 9:d&&console.log(f+" - Now retrying PS attachment");k=7;setTimeout(function(){b.cmd("AT+CGATT=1\r\n",
3E4,h)},3E4);break;case 10:d&&console.log("debug AT_CURRENT_OPERATOR :"+f);if("OK"===f)n.SMS.init(function(a){d&&console.log(a)}),a(null);else{if(f&&"+COPS:"==f.substr(0,6))return console.log("currently selected operator :"+f),h;f&&a("Error in COPS? "+f)}void 0===f&&a("AT+COPS? time-out !!!")}};setTimeout(function(){b.cmd("AT\r\n",1E3,h)},500)},reset:function(a){function e(a){digitalWrite(q,w);setTimeout(function(){digitalWrite(q,!w);setTimeout(function(){n.init(a)},6E3)},200)}function c(a){digitalWrite(u,
x);setTimeout(function(){digitalWrite(u,!x);setTimeout(function(){q?e(a):n.init(a)},5E3)},200)}digitalWrite(B10,1);digitalWrite(B5,1);digitalWrite(B12,1);digitalWrite(C5,1);digitalWrite(C0,0);for(var b=0;12>b;b++)g[b]=void 0,l[b]="";if(void 0===q&&void 0===u)return n.init(a);d&&console.log("Here we go trhough reset sequence");q&&digitalWrite(q,!w);u?c(a):e(a)},getVersion:function(a){b.cmd("AT+GMR\r\n",1E3,function(e){a(e)})},connect:function(a,e,c,k){var g=0,h=function(a){switch(g){case 0:d&&console.log("connect callback after PDP context configuration");
"OK"===a?(g=1,d&&console.log("PDP context successfully configured"),b.cmd("AT+QIACT=1\r\n",3E4,h)):a&&k("Error in "+g+": "+a);void 0===a&&d&&console.log("PDP context activation failed, timeout...");break;case 1:d&&console.log("connect callback after PDP context activation"),"OK"===a?(console.log("PDP context successfully activated"),k(null)):a?k("Error in "+g+": "+a):k(null)}};d&&console.log("in the connect function: AT+QICSGP stage");b.cmd('AT+QICSGP=1,1,"'+a+'", "'+e+'", "'+c+'"\r\n',3E4,h)},initflowctrl:function(a){A=
void 0===a?!1:a},getIP:function(a){var e="",c=function(b){d&&console.log("AT+CGPADDR callback: "+b);if(void 0===b)d&&console.log("timeout : any IP address allocated ..."),a("Wait timeout",e);else if("OK"===b)a(null,e),console.log("IP address allocated, modem is ready to use");else return e=b.substr(13),e=e.substr(0,e.length-1),d&&console.log(b),c};d&&console.log("getIP is AT+CGPADDR");b.cmd("AT+CGPADDR=1\r\n",3E4,c)},geoLocGet:function(a){d&&console.log("Getting geolocalization data");void 0===m.lat?
a("GPS not ready"):a(null,m)},geoLocConvert:function(a){var e={lat:"",lng:""};try{e.lat=m.lat.substr(0,2)+"'"+m.lat.substr(2,m.lat.length-3)+"''"+m.lat.substr(m.lat.length-1),e.lng=m.lng.substr(0,3)+"'"+m.lng.substr(3,m.lng.length-4)+"''"+m.lng.substr(m.lng.length-1)}catch(c){a("Cannot convert geolocalization data")}a(null,e)},geoLocStart:function(a){console.log("Starting GeoLocalization");1E4>a&&console.log("unpredictive behaviour with period not greater than 10 s !");y=!0;var e=function(c){if(void 0===
c)d&&console.log("GeoLocalization timeout"),r="";else if("OK"===c){if(d&&console.log("GeoLocalization acquisition done : "+r),0>r.indexOf("ERROR")){c=r.split(",");try{m={time:c[0],lat:c[1],lng:c[2],hdop:c[3],altitude:c[4],fix:c[5],cog:c[6],spkm:c[7],spkn:c[8],date:c[9],nsat:c[10]}}catch(h){}}}else{if(c&&"+QGPSLOC: "==c.substr(0,10)){var g=c.length,l=c.indexOf(" ");r=c.substring(1+l,g);return e}r="";console.log("Geolocalization error : "+c)}y&&setTimeout(function(){b.cmd("AT+QGPSLOC?\r\n",2E3,e)},
a)};b.cmd("AT+QGPS=1\r\n",2E3,e)},geoLocStop:function(){console.log("Stopping GeoLocalization");y=!1;b.cmd("AT+QGPSEND\r\n");r=""},SMS:{init:function(a){b.cmd("AT+CMGF=1\r\n",1E3,function(e){a&&a("OK"==e?null:"CMGF ERROR "+e)});b.registerLine("+CMTI: ",function(a){a=a.substr(7).split(",")[1];n.emit("message",a);return""})},read:function(a,e){var c;b.cmd("AT+CMGR="+a+"\r\n",2E3,function t(a){if(void 0!==c&&void 0!==a&&"OK"!==a){var b=!1;if(0==(a.length&3)){b=!0;for(var d=0;d<a.length;d+=4){var g=parseInt(a.substr(d,
4),16);if(isNaN(g)){b=!1;break}else c.text+=String.fromCharCode(g)}}b||(c.text=a);return t}if(a&&"+CMGR: "==a.substr(0,7)){try{-1!==a.indexOf(",,")&&(a=a.replace(",,",',"",')),b=JSON.parse("["+a.substr(7)+"]"),c={isRead:"REC READ"==b[0],oaddr:b[1],oname:b[2],time:b[3],text:""}}catch(K){}return t}"OK"===a&&e&&e(a,c);return""})},send:function(a,d,c){b.register(">",function(){b.unregister(">");b.write(d+"\u001a\r");return""});b.cmd('AT+CMGS="'+a+'"\r\n',1E4,function t(a){b.unregister(">");if(a&&"+CMGS"==
a.substr(0,5))return t;c&&c("OK"==a?null:"CMGS ERROR "+a)})},list:function(a,d){var c=[],e;b.cmd('AT+CMGL="'+a+'"\r\n',1E4,function h(a){if(void 0!==e&&void 0!==a){var b=!1;if(0==(a.length&3)){b=!0;for(var f=0;f<a.length;f+=4){var g=parseInt(a.substr(f,4),16);if(isNaN(g)){b=!1;break}else e.text+=String.fromCharCode(g)}}b||(e.text=a);e=void 0;return h}if(a&&"+CMGL: "==a.substr(0,7)){try{-1!==a.indexOf(",,")&&(a=a.replace(",,",',"",')),b=JSON.parse("["+a.substr(7)+"]"),e={index:b[0],isRead:"REC READ"==
b[1],oaddr:b[2],oname:b[3],time:b[4],text:""},c.push(e)}catch(L){}return h}d&&d(a,c);return""})},"delete":function(a,d){b.cmd("AT+CMGD="+a+"\r\n",1E3,function(a){d&&d("OK"==a?null:"CMGD ERROR "+a)})}},Call:{call:function(a,d){b.cmd("ATD"+a+";\r\n",function(a){d&&d("OK"==a?null:"ATD ERROR "+a)})},answer:function(a){b.cmd("ATA\r\n",function(b){a&&a("OK"==b?null:"ATA ERROR "+b)})},hangup:function(a){b.cmd("ATH\r\n",function(b){a&&a("OK"==b?null:"ATH ERROR "+b)})},handleRing:function(a){!0===a?b.registerLine("RING",
function(a){d&&console.log("RingHandler in: "+a);n.emit("RING");return""}):b.unregisterLine("RING")}},sleep:function(a){pinMode(C0,"output");b.cmd("AT+QSCLK=1\r\n",function(b){digitalWrite(A1,1);digitalWrite(C0,1);a&&a("OK"==b?null:"Error: AT+QSCLK=1 "+b);pinMode(C0,"output")})},wakeup:function(a){pinMode(A1,"output");digitalWrite(A1,0);setTimeout(function(){b.cmd("AT+QSCLK=0\r\n",1E3,function(b){pinMode(A1,"input");a&&a("OK"==b?null:"Error: AT+QSCLK=0 "+b)})},1E3)}};resetOptions={rst:"C3",pwrkey:"C4",
rst_active_level:0,pwrkey_active_level:0};exports.connect=function(a){q=resetOptions.rst||void 0;u=resetOptions.pwrkey||void 0;w=resetOptions.rst_active_level||0;x=resetOptions.pwrkey_active_level||0;Serial2.setup(115200,{tx:A2,rx:A3});n.at=b=require("AT").connect(Serial2);require("NetworkJS").create(J);b.register('+QIURC: "recv"',z);b.register("+D",B);b.register('+QIURC: "closed"',C);b.register('+QIURC: "pdpdeact"',D);b.register("+QIND:",F);b.register("+QUSIM:",G);b.register("+CFUN:",H);b.register("RDY",
I);n.reset(a);return n}