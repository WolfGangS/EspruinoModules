function f(b,a){this.server=b;a=a||{};this.port=a.port||m.DEF_PORT;this.client_id=a.client_id||r();this.keep_alive=a.keep_alive||m.DEF_KEEP_ALIVE;this.clean_session=a.clean_session||!0;this.username=a.username;this.password=a.password;this.connected=this.client=!1;this.pakId=Math.floor(65534*Math.random());this.ping_interval=this.keep_alive<this.C.PING_INTERVAL?this.keep_alive-5:this.C.PING_INTERVAL;this.protocol_name=a.protocol_name||"MQTT";this.protocol_level=g(parseInt((a.protocol_level||
m.PROTOCOL_LEVEL).toString(16),16))}function h(b){return g(b.length>>8,b.length&255)+b}function t(b){var a=1,k=0,c=0;do{var e=b.charCodeAt(k++),c=c+a*(e&127),a=128*a;if(2097152<a)return 0;if(0===(e&128))break}while(5>k);return{decLen:c,lenBy:k}}function l(b,a,k){b=g(b);var c=a.length+k.length,e="";do{var d=c&127,c=c>>7;0<c&&(d+=128);e+=g(d)}while(0<c);return b+e+a+k}function u(b){if(3<=b.length&&"undefined"!==typeof b){var a=b.charCodeAt(0),d=b.charCodeAt(1)<<8|b.charCodeAt(2);return{topic:b.substr(3,
d),message:b.substr(3+d,b.length-d),dup:(a&8)>>3,qos:(a&6)>>1,retain:a&1}}}function n(){this.pakId=65534<this.pakId?1:++this.pakId;return g(this.pakId>>8)+g(this.pakId&255)}function p(b){return g(b.charCodeAt(0))+g(b.charCodeAt(1))}function v(b,a,k){var c=d.PUBLISH<<4|k<<1;b=h(b);0<k&&(b+=n());return l(c,b,a)}function w(b,a){return l(d.SUBSCRIBE<<4|2,n(),h(b)+g(a))}function x(b){return l(d.UNSUBSCRIBE<<4|2,n(),h(b))}var m={PROTOCOL_LEVEL:4,DEF_PORT:1883,DEF_KEEP_ALIVE:60},d={CONNECT:1,CONNACK:2,PUBLISH:3,
PUBACK:4,PUBREC:5,PUBREL:6,PUBCOMP:7,SUBSCRIBE:8,SUBACK:9,UNSUBSCRIBE:10,UNSUBACK:11,PINGREQ:12,PINGRESP:13,DISCONNECT:14},q={0:"ACCEPTED",1:"UNACCEPTABLE_PROTOCOL_VERSION",2:"IDENTIFIER_REJECTED",3:"SERVER_UNAVAILABLE",4:"BAD_USER_NAME_OR_PASSWORD",5:"NOT_AUTHORIZED"};f.prototype.C={DEF_QOS:0,CONNECT_TIMEOUT:5E3,PING_INTERVAL:40};var g=String.fromCharCode,r=function(){function b(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}return function(){return b()+b()+b()}}();f.prototype.connect=
function(b){var a=this,k=function(){a.pintr&&clearInterval(a.pintr);a.pintr=setInterval(function(){a.ping()},1E3*a.ping_interval)},c=function(){b.write(a.mqttConnect(a.client_id));a.ctimo=setTimeout(function(){a.ctimo=void 0;a.emit("disconnected");a.disconnect()},a.C.CONNECT_TIMEOUT);b.on("data",function(e){a.partData&&(e=a.partData+e,a.partData="");var c=e.charCodeAt(0)>>4,f=t(e.substr(1,5)),h=f.decLen+f.lenBy+1;e.length<h?a.partData=e:(f=e.substr(f.lenBy+1,h),e.length>h&&b.emit("data",e.substr(h)),
c!==d.PINGRESP&&k(),c===d.PUBLISH?(e=u(e.charAt(0)+f),void 0!==e&&(a.emit("publish",e),a.emit("message",e.topic,e.message))):c!==d.PUBACK&&(c===d.PUBREC?b.write(g(d.PUBREL<<4|2)+"\u0002"+p(f)):c===d.PUBREL?b.write(g(d.PUBCOMP<<4)+"\u0002"+p(f)):c!==d.PUBCOMP&&c!==d.SUBACK&&c!==d.UNSUBACK&&(c===d.PINGREQ?b.write(g(d.PINGRESP<<4)+"\x00"):c===d.PINGRESP?a.emit("ping_reply"):c===d.CONNACK?(a.ctimo&&clearTimeout(a.ctimo),a.ctimo=void 0,a.partData="",e=f.charCodeAt(3),"ACCEPTED"===q[e]?(a.connected=!0,
k(),a.emit("connected"),a.emit("connect")):(c="Connection refused, ",a.connected=!1,c=0<e&&6>e?c+q[e]:c+("unknown return code: "+e+"."),a.emit("error",c))):(a.emit("error","MQTT unsupported packet type: "+c),console.log("[MQTT]"+e.split("").map(function(a){return a.charCodeAt(0)}))))))});b.on("end",function(){a.connected&&(a.connected=!1,a.pintr&&clearInterval(a.pintr),a.pintr=a.ctimo=void 0,a.emit("disconnected"),a.emit("close"))});a.client=b};b?c():b=require("net").connect({host:a.server,port:a.port},
c)};f.prototype.disconnect=function(){this.client&&(this.client.write(g(d.DISCONNECT<<4)+"\x00"),this.client.end(),this.client=!1)};f.prototype.publish=function(b,a,d){this.client&&this.client.write(v(b,a.toString(),d||this.C.DEF_QOS))};f.prototype.subscribe=function(b,a,d){if(this.client){a=("number"===typeof a?{qos:a}:a)||{qos:this.C.DEF_QOS};var c=[];"string"===typeof b&&(b=[b]);Array.isArray(b)?b.forEach(function(b){c.push({topic:b,qos:a.qos})}):Object.keys(b).forEach(function(a){c.push({topic:a,
qos:b[a]})});c.forEach(function(a){this.client.write(w(a.topic,a.qos))}.bind(this));"function"===typeof d&&d()}};f.prototype.unsubscribe=function(b){this.client&&this.client.write(x(b))};f.prototype.ping=function(){this.client&&this.client.write(g(d.PINGREQ<<4)+"\x00")};f.prototype.createFlagsForConnection=function(b){var a=0|(this.username?128:0);a|=this.username&&this.password?64:0;a|=b.clean_session?2:0;return g(parseInt(a.toString(16),16))};f.prototype.mqttConnect=function(b){var a=d.CONNECT<<
4;b=this.createFlagsForConnection({clean_session:b});var f=g(this.keep_alive>>8,this.keep_alive&255),c=h(this.client_id);this.username&&(c+=h(this.username),this.password&&(c+=h(this.password)));return l(a,h(this.protocol_name)+this.protocol_level+b+f,c)};exports.create=function(b,a){return new f(b,a)};exports.connect=function(b){b=new f(b.host,b);b.connect();return b}