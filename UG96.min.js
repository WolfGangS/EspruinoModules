function w(a,k,d,h){b&&console.log("AT+QIOPEN=1,"+a+',"TCP",'+JSON.stringify(k)+","+d+",0,1");c.cmd("AT+QIOPEN=1,"+a+',"TCP",'+JSON.stringify(k)+","+d+",0,1\r\n",15E4,function e(g){if("OK"==g)return b&&console.log("AT+QIOPEN OK"),e;g=="+QIOPEN: "+a+",0"?(b&&console.log(g),b&&console.log("AT+QIOPEN completed with socket: "+a),f[a]=!0):g=="+QIOPEN: "+a+",565"?(b&&console.log("AT+QIOPEN failure DNS parse failed..."),f[a]="tobeclosed"):g=="+QIOPEN: "+a+",566"?(b&&console.log("AT+QIOPEN failure could not connect socket ..."),
5>h?setTimeout(function(){console.log("repeat opening the socket ...");w(a,k,d,h+1)},3E3):f[a]="tobeclosed"):g=="+QIOPEN: "+a+",563"?(b&&console.log("AT+QIOPEN socket identity has been used..., socket is:"+a),f[a]=!0):(b&&console.log("AT+QIOPEN failed on socket:"+a),b&&c.cmd("AT+QIGETERROR\r\n",1E3,function(a){b&&console.log(a)}),f[a]="tobeclosed");return""})}function t(a){f[a]?m?(b&&console.log("at register currenly programmed"),setTimeout(function(){console.log("closing later...");t(a)},1500)):
c.isBusy()?(b&&console.log("AT busy"),setTimeout(function(){console.log("closing again...");t(a)},1500)):(b&&console.log("sending AT+QICLOSE for socket "+a),c.cmd("AT+QICLOSE="+a+"\r\n",1E3,function(k){b&&console.log(k);"OK"==k?(b&&console.log("socket "+a+" is closed"),f[a]=void 0):(b&&console.log("cannot close socket now"+a+",error="+k),f[a]="tobeclosed")})):b&&console.log("socket already closed")}function y(a){var b=a.indexOf("\r\n");if(0>b)return a;var d=a.substring(15,b).split(",");d[1]|=0;var c=
a.length-(b+2);if(c>=d[1])return l[d[0]]+=a.substr(b+2,d[1]),a.substr(b+d[1]+3);l[d[0]]+=a.substr(b+2,c);return"+D,"+d[0]+","+(d[1]-c)+":"}function B(a){var b=a.indexOf(":");if(0>b)return a;var d=a.substring(3,b).split(",");d[1]|=0;var c=a.length-(b+1);if(c>=d[1])return l[d[0]]+=a.substr(b+1,d[1]),a.substr(b+d[1]+1);l[d[0]]+=a.substr(b+1,c);return"+D,"+d[0]+","+(d[1]-c)+":"}function C(a){b&&console.log("closehandler:"+a);var c=a.indexOf("\r\n");if(0>c&&(b&&console.log("not enough data "+a),c=a.indexOf("\r"),
0>c))return b&&console.log("definitively not enough data "+a),a;a=a.substring(0,c).split(",");a[1]|=0;t(a[1]);return""}function D(a){b&&console.log("pdpdeacthandler:"+a);c.cmd("AT+QIDEACT=1\r\n",1E3,function(a){b&&console.log(a);for(a=0;12>a;a++)f[a]=void 0,l[a]=""});return""}function F(a){b&&console.log("QindHandler in: "+a);return""}function G(a){b&&console.log("QusimHandler in: "+a);return""}function H(a){b&&console.log("CfunHandler in: "+a);return""}function I(a){b&&console.log("RdyHandler in: "+
a);return""}function J(a){b&&console.log("PowerDownHandler in: "+a);console.log("Modem is entering in power down");digitalWrite(q,u);return""}var c,m=!1,f=[],l="           ".split(" "),n,v,q,u,z=!1,p="",x=!1,b=!1,A,K={create:function(a,k){var d=0;if(void 0===a)return b&&console.log("WARNING: this has not been fully ported for UGxx"),d=12,f[d]="Wait",l[d]="",c.cmd("AT+CIPSERVER=1,"+k+"\r\n",1E4,function(a){if("OK"==a)f[d]=!0;else throw f[d]=void 0,Error("CIPSERVER failed");}),12;for(;void 0!==f[d];)d++;
12<=d&&(b&&console.log("WORKAROUND closing the socket: "+d),d--,c.cmd("AT+QICLOSE="+d+"\r\n",1E3,function(a){b&&console.log(a);f[d]=void 0}));f[d]="Wait";l[d]="";443==k?(b&&console.log("delaying the TLS socket opening"),setTimeout(function(){w(d,a,k,0)},3E3)):w(d,a,k,0);return d},close:function(a){b&&console.log("(local) Closing of the socket: "+a);t(a)},accept:function(a){b&&console.log("Accept Socket",a);for(a=0;12>a;a++)if(l[a]&&void 0===f[a])return f[a]=!0,a;return-1},recv:function(a,b){if(c.isBusy()||
"Wait"==f[a])return"";if(l[a]){if(l[a].length>b){var d=l[a].substr(0,b);l[a]=l[a].substr(b)}else d=l[a],l[a]="";return d}return f[a]&&"tobeclosed"!=f[a]?"":-1},send:function(a,k){if(m||c.isBusy()||"Wait"==f[a])return 0;if("tobeclosed"==f[a]||!f[a])return-1;if(1460<k.length)return b&&console.log("data too big"),-1;m=!0;var d=setTimeout(function(){console.log("Abort waiting prompt (for sending data)");m=!1;c.unregister(">")},1E3);c.register(">",function(){b&&console.log("Prompt coming, sending data ...");
c.unregister(">");clearTimeout(d);c.write(k);return""});var h=setTimeout(function(){console.log("Abort waiting modem response (sending data)");m=!1;c.unregisterLine("SEND OK");c.unregisterLine("SEND FAIL");c.unregisterLine("ERROR")},1E3);c.registerLine("SEND OK",function(){b&&console.log("UGxx - SEND OK");c.unregisterLine("SEND OK");c.unregisterLine("SEND FAIL");c.unregisterLine("ERROR");clearTimeout(h);m=!1;return""});c.registerLine("SEND FAIL",function(){b&&console.log("UGxx - SEND FAIL");c.unregisterLine("SEND OK");
c.unregisterLine("SEND FAIL");c.unregisterLine("ERROR");clearTimeout(h);m=!1;"tobeclosed"==f[a];return""});c.registerLine("ERROR",function(){b&&console.log("UGxx - ERROR communication");c.unregisterLine("SEND OK");c.unregisterLine("SEND FAIL");c.unregisterLine("ERROR");clearTimeout(h);m=!1;"tobeclosed"==f[a];return""});c.write("AT+QISEND="+a+","+k.length+"\r\n");return k.length}},r={receiveHandler:y,debug:function(a,k){b=void 0===a?!1:a;(void 0===k?0:k)&&c.debug();return{socks:f,sockData:l}},init:function(a){var k=
0,d=0,h=0,f=!1,g=function(e){switch(h){case 0:b&&console.log("debug AT_SYNCHRO :"+e);if("AT"===e)return g;"OK"===e?(console.log("AT passed"),h=1,c.cmd("ATV1\r\n",1E3,g)):(h=0,k++,b&&console.log("AT sync failed: "+e),10>=k?setTimeout(function(){c.cmd("AT\r\n",1E3,g)},500):(b&&console.log("No OK return after 10 times"),b&&console.log("Check the module is power on"),a("Error in AT sync: "+e)));break;case 1:b&&console.log("debug AT_RSP_FORMAT :"+e);if("OK"===e)h=2,c.cmd("ATE0\r\n",1E3,g);else{if("ATV1"===
e)return g;e&&a("Error in ATV1: "+e)}void 0===e&&(b&&console.log("Cannot set TA response format"),a("ATV1 time-out !!!"));break;case 2:b&&console.log("debug AT_ECHO_OFF :"+e);if("IIIIATE0"===e||e==="IIII"+String.fromCharCode(255)+"ATE0"||"ATE0"===e)return g;"OK"===e?(b&&console.log("ATE0 passed: "+e),z?(h=10,c.cmd("AT+IFC=2,2\r\n",2E3,g)):(h=3,c.cmd("AT+CPIN?\r\n",5E3,g))):"atE0"===e?(b&&console.log("UGxx returns "+e),h=3,c.cmd("AT+CPIN?\r\n",5E3,g)):e&&a("Error in ATE0: "+e);void 0===e&&(b&&console.log("ATE0 time-out !!!"),
h=3,c.cmd("AT+CPIN?\r\n",5E3,g));break;case 10:b&&console.log("debug AT_HW_FLOW_CONTROL :"+e);"OK"===e?b&&console.log("HW flow control establismnent succeeded"):a("HW flow control establismnent failed");h=3;c.cmd("AT+CPIN?\r\n",5E3,g);break;case 3:b&&console.log("debug AT_CPIN :"+e);if("+CPIN: READY"===e)return g;"OK"===e?(h=4,c.cmd("AT+QCCID\r\n",2E3,g)):e&&a("Error in CPIN: "+e);void 0===e&&(b&&console.log("SIM cannot be read, SIM is either protected, blocked or not accessible"),a("AT+CPIN time-out !!!"));
break;case 4:b&&console.log("debug AT_SHOW_SIM_ID :"+e);if(e&&"+QCCID:"==e.substr(0,7))return b&&console.log("SIM ID :"+e),A=e.substring(8,e.length-1),g;"OK"===e?(h=5,c.cmd("AT+CSQ\r\n",2E3,g)):e&&a("Error in QCCID: "+e);void 0===e&&a("AT+QCCID time-out !!!");break;case 5:b&&console.log("debug AT_QUERY_SIGNAL_QUALITY :"+e);if(e&&"+CSQ:"==e.substr(0,5))return e&&"+CSQ: 99,99"==e.substr(0,11)?(b&&console.log("Signal not known or not detectable yet"),f=!1):(f=!0,b&&console.log("Info signal :"+e)),g;
"OK"===e?f?(h=6,b&&console.log("PS attachment is starting. It may take until a minute, please wait ... "),setTimeout(function(){c.cmd("AT+CGATT=1\r\n",75E3,g)},5E3)):setTimeout(function(){c.cmd("AT+CSQ\r\n",2E3,g)},500):e&&a("Error in QCCID: "+e);void 0===e&&a("AT+CSQ time-out !!!");break;case 6:b&&console.log("debug AT_PS_ATTACMENT :"+e);"OK"===e?(console.log("PS attachment succeeded"),h=9,c.cmd("AT+COPS?\r\n",2E4,g)):e&&(d+=1,b&&console.log("Error in CGATT: "+e+" - retry: "+d),1==d?(b&&console.log("Trying an automatic registration first. It may take until 3 minutes, please wait ..."),
h=7,setTimeout(function(){c.cmd("AT+COPS=0\r\n",18E4,g)},2E3)):4>d?(b&&console.log("Retrying CGATT"),h=6,b&&console.log("PS attacment is attempting again. It may take until a minute, please wait ... "),setTimeout(function(){c.cmd("AT+CGATT=1\r\n",75E3,g)},2E3*d)):a("Unrecoverable Error, PS attachment failed: "+e));break;case 7:b&&console.log("COPS returns: "+e);h=8;setTimeout(function(){c.cmd("AT+COPS?\r\n",1E4,g)},5E3);break;case 8:b&&console.log(e+" - Now retrying PS attachment");h=6;setTimeout(function(){c.cmd("AT+CGATT=1\r\n",
3E4,g)},3E4);break;case 9:b&&console.log("debug AT_CURRENT_OPERATOR :"+e);if("OK"===e)a(null);else{if(e&&"+COPS:"==e.substr(0,6))return console.log("currently selected operator :"+e),g;e&&a("Error in COPS? "+e)}void 0===e&&a("AT+COPS? time-out !!!")}};setTimeout(function(){c.cmd("AT\r\n",1E3,g)},500)},reset:function(a){function c(a){digitalWrite(n,v);setTimeout(function(){digitalWrite(n,!v);setTimeout(function(){r.init(a)},6E3)},200)}function d(a){digitalWrite(q,u);setTimeout(function(){digitalWrite(q,
!u);setTimeout(function(){n?c(a):r.init(a)},5E3)},200)}for(var h=0;12>h;h++)f[h]=void 0,l[h]="";if(void 0===n&&void 0===q)return r.init(a);b&&console.log("Here we go trhough reset sequence");n&&digitalWrite(n,!v);q?d(a):c(a)},getVersion:function(a){c.cmd("AT+GMR\r\n",1E3,function(b){a(null,b)})},connect:function(a,k,d,h){var f=0,g=function(a){switch(f){case 0:b&&console.log("connect callback after PDP context configuration");"OK"===a?(f=1,b&&console.log("PDP context successfully configured"),c.cmd("AT+QIACT=1\r\n",
3E4,g)):a&&h("Error in "+f+": "+a);void 0===a&&b&&console.log("PDP context activation failed, timeout...");break;case 1:b&&console.log("connect callback after PDP context activation"),"OK"===a?(console.log("PDP context successfully activated"),h(null)):a?h("Error in "+f+": "+a):h(null)}};b&&console.log("in the connect function: AT+QICSGP stage");c.cmd('AT+QICSGP=1,1,"'+a+'", "'+k+'", "'+d+'"\r\n',3E4,g)},initflowctrl:function(a){z=void 0===a?!1:a},getIP:function(a){var k="",d=function(c){b&&console.log("AT+CGPADDR callback: "+
c);if(void 0===c)b&&console.log("timeout : any IP address allocated ..."),a(null,k);else if("OK"===c)a(null,k),console.log("IP address allocated, modem is ready to use");else return k+=c,b&&console.log(c),d};b&&console.log("getIP is AT+CGPADDR");c.cmd("AT+CGPADDR=1\r\n",3E4,d)},geoLocGet:function(a){console.log("Getting geolocalization data");a(p)},geoLocStart:function(a){console.log("Starting GeoLocalization");1E4>a&&console.log("unpredictive behaviour with period not greater than 10 s !");x=!0;
var k=function(d){if(void 0===d)b&&console.log("GeoLocalization timeout"),p="";else if("OK"===d)console.log("GeoLocalization acquisition done : "+p);else{if(d&&"+QCELLLOC:"==d.substr(0,10)){var f=d.length,l=d.indexOf(" ");p=d.substring(1+l,f);b&&console.log(p);return k}p="";console.log("Geolocalization error : "+d)}x&&setTimeout(function(){c.cmd("AT+QCELLLOC=1\r\n",2E3,k)},a)};c.cmd("AT+QCELLLOC=1\r\n",2E3,k)},geoLocStop:function(){console.log("Stopping GeoLocalization");x=!1;p=""},turnOff:function(){console.log("Turning Off the modem");
c.cmd("AT+QPOWD=1\r\n",2E3,function(a){"OK"===a?console.log("Please wait, disconnecting and saving data. It may last until 60 s"):console.log("Turn off error : "+a)})},getCCID:function(){return A}};resetOptions={rst:void 0,pwrkey:void 0,rst_active_level:1,pwrkey_active_level:1};exports.connect=function(a,b,d){b=b||{};n=b.rst||void 0;q=b.pwrkey||void 0;v=b.rst_active_level||0;u=b.pwrkey_active_level||0;r.at=c=require("AT").connect(a);require("NetworkJS").create(K);c.register('+QIURC: "recv"',y);c.register("+D",
B);c.register('+QIURC: "closed"',C);c.register('+QIURC: "pdpdeact"',D);c.register("+QIND:",F);c.register("+QUSIM:",G);c.register("+CFUN:",H);c.register("RDY",I);c.register("POWERED DOWN",J);r.reset(d);return r}