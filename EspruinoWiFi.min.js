function v(a){var b=a.indexOf(":");if(0>b)return a;var d=a.substring(5,b).split(",");d[1]|=0;var c=a.length-(b+1);if(c>=d[1])return f[d[0]]+=a.substr(b+1,d[1]),a.substr(b+d[1]+1);f[d[0]]+=a.substr(b+1,c);return"+IPD,"+d[0]+","+(d[1]-c)+":"}function n(a,b){if(b)return a(b);c.cmd("AT+CWMODE="+g+"\r\n",1E3,function(b){"no change"!=b&&"OK"!=b&&"WIFI DISCONNECT"!=b?a("CWMODE failed: "+(b?b:"Timeout")):a(null)})}function h(a){e[a[0]]="Wait"==e[a[0]]?!0:"Accept"}function k(a){e[a[0]]=""!=f[a[0]]?
"DataClose":void 0}function p(a,b){var d=0==g;g|=a;d?(q.setup(115200,{rx:A3,tx:A2}),c=require("AT").connect(q),c.register("+IPD",v),c.registerLine("0,CONNECT",h),c.registerLine("1,CONNECT",h),c.registerLine("2,CONNECT",h),c.registerLine("3,CONNECT",h),c.registerLine("4,CONNECT",h),c.registerLine("0,CLOSED",k),c.registerLine("1,CLOSED",k),c.registerLine("2,CLOSED",k),c.registerLine("3,CLOSED",k),c.registerLine("4,CLOSED",k),exports.at=c,require("NetworkJS").create(t),c.cmd("\r\nAT+RST\r\n",1E4,function l(a){if("ready"==
a||"Ready."==a)setTimeout(function(){c.cmd("ATE0\r\n",1E3,function w(a){if("ATE0"==a)return w;"OK"==a?c.cmd("AT+CIPMUX=1\r\n",1E3,function(a){"OK"!=a?b("CIPMUX failed: "+(a?a:"Timeout")):n(b)}):b("ATE0 failed: "+(a?a:"Timeout"))})},500);else if(void 0===a)b("No 'ready' after AT+RST");else return l}),digitalWrite(x,1),digitalWrite(r,1)):n(b)}function u(a){(g&=~a)?n(function(){},null):(q.removeAllListeners(),c=void 0,exports.at=void 0,digitalWrite(r,0),e=[])}var x=A13,r=A14,q=Serial2;digitalWrite(r,
0);var y=["open","wep","wpa_psk","wpa2_psk","wpa_wpa2_psk"],g=0,c,e=[],f=["","","","",""],t={create:function(a,b){if(!c)return-1;if(void 0===a){var d=5;e[d]="Wait";f[d]="";c.cmd("AT+CIPSERVER=1,"+b+"\r\n",1E4,function(a){"OK"==a?e[d]=!0:(e[d]=void 0,setTimeout(function(){throw Error("CIPSERVER failed ("+(a?a:"Timeout")+")");},0))});return 5}for(d=0;void 0!==e[d];)d++;if(5<=d)return-7;e[d]="Wait";f[d]="";c.cmd("AT+CIPSTART="+d+',"TCP",'+JSON.stringify(a)+","+b+"\r\n",1E4,function(a){"OK"!=a&&(e[d]=
-6)});return d},close:function(a){"Wait"==e[a]?e[a]="WaitClose":void 0!==e[a]&&(0>e[a]?e[a]=void 0:c.cmd((5==a?"AT+CIPSERVER=0":"AT+CIPCLOSE="+a)+"\r\n",1E3,function(b){e[a]=void 0}))},accept:function(a){for(a=0;5>a;a++)if("Accept"==e[a])return e[a]=!0,a;return-1},recv:function(a,b){if(f[a]){if(f[a].length>b){var d=f[a].substr(0,b);f[a]=f[a].substr(b)}else d=f[a],f[a]="","DataClose"==e[a]&&(e[a]=void 0);return d}return 0>e[a]?e[a]:e[a]?"":-1},send:function(a,b){if(!c)return-1;if(c.isBusy()||"Wait"==
e[a])return 0;if(0>e[a])return e[a];if(!e[a])return-1;c.cmd("AT+CIPSEND="+a+","+b.length+"\r\n",1E4,function m(l){if("OK"==l)return c.register("> ",function(){c.unregister("> ");c.write(b);return""}),m;if(l=="Recv "+b.length+" bytes")return m;"SEND OK"==l?("WaitClose"==e[a]&&t.close(a),e[a]=!0):(e[a]=void 0,c.unregister("> "))});e[a]="Wait";return b.length}};exports.connect=function(a,b,d){var e="";d=d||function(){};void 0!==b.password&&(e=b.password);p(1,function(b){if(b)return d(b);c.cmd("AT+CWJAP="+
JSON.stringify(a)+","+JSON.stringify(e)+"\r\n",2E4,function z(a){if(0<=["WIFI DISCONNECT","WIFI CONNECTED","WIFI GOT IP","+CWJAP:1"].indexOf(a))return z;"OK"!=a?setTimeout(d,0,"WiFi connect failed: "+(a?a:"Timeout")):setTimeout(d,0,null)})})};exports.disconnect=function(){u(1)};exports.getIP=function(a){var b={};c.cmd("AT+CIFSR\r\n",1E3,function m(c){if(void 0===c)a("Timeout");else{if("+CIFSR:STAIP"==c.substr(0,12))b.ip=c.slice(14,-1);else if("+CIFSR:STAMAC"==c.substr(0,13))b.mac=c.slice(15,-1);else if("OK"==
c){a(null,b);return}return m}})};exports.startAP=function(a,b,d){b=b||{};if(!b.password||8>b.password.length)throw Error("Password must be at least 8 characters");var e=b.password?"3":"0";if(b.authMode&&(e={open:0,wpa:2,wpa2:3,wpa_wpa2:4}[b.authMode],void 0===e))throw Error("Unknown authMode "+b.authMode);void 0===b.channel&&(b.channel=5);p(2,function(f){if(f)return d(f);c.cmd("AT+CWSAP="+JSON.stringify(a)+","+JSON.stringify(b.password)+","+b.channel+","+e+"\r\n",5E3,function(a){"OK"!=a?d("CWSAP failed: "+
(a?a:"Timeout")):d(null)})})};exports.stopAP=function(){u(2)};exports.scan=function(a){var b=[];p(1,function(d){if(d)return a(d);c.cmdReg("AT+CWLAP\r\n",5E3,"+CWLAP:",function(a){a=a.slice(8,-1).split(",");b.push({ssid:JSON.parse(a[1]),authMode:y[a[0]],rssi:parseInt(a[2]),mac:JSON.parse(a[3]),channel:JSON.parse(a[4])})},function(c){a(null,b)})})};exports.debug=function(){return{wifiMode:g,socks:e,sockData:f}}