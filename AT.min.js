exports.connect=function(l){var m=!1,a="",d,b={},e={},g=[];l.on("data",function(f){a+=f;m&&console.log("] "+JSON.stringify(a)+" <--- "+JSON.stringify(f));"\n"==a[0]&&(a=a.substr(1));if(b){b[">"]&&">"==a[0]&&(a=b[">"](a));for(var c in b)a.substr(0,c.length)==c&&(a=b[c](a))}for(f=a.indexOf("\r");0<=f;){var k=a.substr(0,f);if(0<k.length){var n=!1;for(c in e)k.substr(0,c.length)==c&&(e[c](k),n=!0);n||d&&d(k)}a=a.substr(f+1);"\n"==a[0]&&(a=a.substr(1));if(a.length&&b)for(c in b[">"]&&">"==
a[0]&&(a=b[">"](a)),b)a.substr(0,c.length)==c&&(a=b[c](a));f=a.indexOf("\r")}});var h={debug:function(){m=!0;return{line:a,lineCallback:d,handlers:b,lineHandlers:e,waiting:g}},cmd:function(a,c,b){if(d)g.push([a,c,b]);else if(m&&console.log("["+JSON.stringify(a)),l.write(a),c){var e=setTimeout(function(){d=void 0;b&&b()},c),p=function(a){d=void 0;var f;b&&(f=b(a))?(d=p,b=f):clearTimeout(e);void 0===d&&0<g.length&&(a=g.shift(),h.cmd(a[0],a[1],a[2]))};d=p}},write:function(a){l.write(a)},cmdReg:function(a,
b,d,e,g){h.registerLine(d,e);h.cmd(a,b,function(a){h.unregisterLine(d);g(a)})},registerLine:function(a,b){if(e[a])throw Error(a+" already registered");e[a]=b},unregisterLine:function(a){delete e[a]},register:function(a,c){if(b[a])throw Error(a+" already registered");b[a]=c},unregister:function(a){delete b[a]},isBusy:function(){return void 0!==d}};return h}