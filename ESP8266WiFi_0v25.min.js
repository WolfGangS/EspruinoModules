function q(a){var d=a.indexOf(":");if(0>d)return a;var c=a.substring(5,d).split(",");c[1]|=0;var f=a.length-(d+1);if(f>=c[1])return g[c[0]]+=a.substr(d+1,c[1]),a.substr(d+c[1]+1);g[c[0]]+=a.substr(d+1,f);return"+IPD,"+c[0]+","+(c[1]-f)+":"}function k(a){b[a[0]]="Wait"==b[a[0]]?!0:"Accept"}function l(a){b[a[0]]=""!=g[a[0]]?"DataClose":void 0}var f,b=[],g=["","","","",""],p=["open","wep","wpa_psk","wpa2_psk","wpa_wpa2_psk"],r={create:function(a,d){if(void 0===a){var c=5;b[c]="Wait";g[c]=
"";f.cmd("AT+CIPSERVER=1,"+d+"\r\n",1E4,function(a){"OK"==a?b[c]=!0:(b[c]=void 0,setTimeout(function(){throw Error("CIPSERVER failed ("+(a?a:"Timeout")+")");},0))});return 5}for(c=0;void 0!==b[c];)c++;if(5<=c)return-7;b[c]="Wait";g[c]="";f.cmd("AT+CIPSTART="+c+',"TCP",'+JSON.stringify(a)+","+d+"\r\n",1E4,function(a){"OK"!=a&&(b[c]=-6)});return c},close:function(a){"Wait"==b[a]?b[a]="WaitClose":void 0!==b[a]&&(0>b[a]?b[a]=void 0:f.cmd((5==a?"AT+CIPSERVER=0":"AT+CIPCLOSE="+a)+"\r\n",1E3,function(d){b[a]=
void 0}))},accept:function(a){for(a=0;5>a;a++)if("Accept"==b[a])return b[a]=!0,a;return-1},recv:function(a,d){if(g[a]){if(g[a].length>d){var c=g[a].substr(0,d);g[a]=g[a].substr(d)}else c=g[a],g[a]="","DataClose"==b[a]&&(b[a]=void 0);return c}return 0>b[a]?b[a]:b[a]?"":-1},send:function(a,d){if(f.isBusy()||"Wait"==b[a])return 0;if(0>b[a])return b[a];if(!b[a])return-1;f.cmd("AT+CIPSEND="+a+","+d.length+"\r\n",1E4,function m(h){if("OK"==h)return f.register("> ",function(){f.unregister("> ");f.write(d);
return""}),m;if(h=="Recv "+d.length+" bytes")return m;"SEND OK"==h?("WaitClose"==b[a]&&r.close(a),b[a]=!0):(b[a]=void 0,f.unregister("> "))});b[a]="Wait";return d.length}},n={ipdHandler:q,debug:function(){return{socks:b,sockData:g}},init:function(a){f.cmd("ATE0\r\n",1E3,function c(b){if("ATE0"==b)return c;"OK"==b?f.cmd("AT+CIPMUX=1\r\n",1E3,function(c){"OK"!=c?a("CIPMUX failed: "+(c?c:"Timeout")):a(null)}):a("ATE0 failed: "+(b?b:"Timeout"))})},reset:function(a){f.cmd("\r\nAT+RST\r\n",1E4,function c(b){if("ready"==
b||"Ready."==b)setTimeout(function(){n.init(a)},1E3);else if(void 0===b)a("No 'ready' after AT+RST");else return c})},getVersion:function(a){f.cmd("AT+GMR\r\n",1E3,function(b){a(null,b)})},connect:function(a,b,c){f.cmd("AT+CWMODE=1\r\n",1E3,function(d){"no change"!=d&&"OK"!=d?c("CWMODE failed: "+(d?d:"Timeout")):f.cmd("AT+CWJAP="+JSON.stringify(a)+","+JSON.stringify(b)+"\r\n",2E4,function t(a){if(0<=["WIFI DISCONNECT","WIFI CONNECTED","WIFI GOT IP","+CWJAP:1"].indexOf(a))return t;"OK"!=a?setTimeout(c,
0,"WiFi connect failed: "+(a?a:"Timeout")):setTimeout(c,0,null)})})},getAPs:function(a){var b=[];f.cmdReg("AT+CWLAP\r\n",5E3,"+CWLAP:",function(a){a=a.slice(8,-1).split(",");b.push({ssid:JSON.parse(a[1]),enc:p[a[0]],signal:parseInt(a[2]),mac:JSON.parse(a[3])})},function(c){a(null,b)})},getConnectedAP:function(a){var b;f.cmdReg("AT+CWJAP?\r\n",1E3,"+CWJAP:",function(a){b=JSON.parse(a.slice(7))},function(c){a(null,b)})},createAP:function(a,b,c,g,h){f.cmd("AT+CWMODE=2\r\n",1E3,function(d){"no change"!=
d&&"OK"!=d&&"WIFI DISCONNECT"!=d&&h("CWMODE failed: "+(d?d:"Timeout"));d=g?p.indexOf(g):0;0>d?h("Encryption type "+g+" not known - "+p):f.cmd("AT+CWSAP="+JSON.stringify(a)+","+JSON.stringify(b)+","+c+","+d+"\r\n",5E3,function(a){"OK"!=a?h("CWSAP failed: "+(a?a:"Timeout")):h(null)})})},getConnectedDevices:function(a){var b=[];this.at.cmd("AT+CWLIF\r\n",1E3,function m(d){if("OK"==d)a(null,b);else if(void 0===d||"ERROR"==d)a("Error");else return e=d.split(","),b.push({ip:e[0],mac:e[1]}),m})},getIP:function(a){var b;
f.cmdReg("AT+CIFSR\r\n",1E3,"+CIFSR",function(a){!b&&0<=a.indexOf(",")&&(b=JSON.parse(a.slice(a.indexOf(",")+1)))},function(c){"OK"!=c?a("CIFSR failed: "+c):a(null,b)})}};exports.connect=function(a,b){n.at=f=require("AT").connect(a);require("NetworkJS").create(r);f.register("+IPD",q);f.registerLine("0,CONNECT",k);f.registerLine("1,CONNECT",k);f.registerLine("2,CONNECT",k);f.registerLine("3,CONNECT",k);f.registerLine("4,CONNECT",k);f.registerLine("0,CLOSED",l);f.registerLine("1,CLOSED",l);f.registerLine("2,CLOSED",
l);f.registerLine("3,CLOSED",l);f.registerLine("4,CLOSED",l);n.reset(b);return n}