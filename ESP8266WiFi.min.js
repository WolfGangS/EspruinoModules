function n(a){var d=a.indexOf(":");if(0>d)return a;var b=a.substring(5,d).split(",");k=b[0];b[1]|=0;var f=a.length-(d+1);if(f>=b[1])return g[b[0]]+=a.substr(d+1,b[1]),a.substr(d+b[1]+1);g[b[0]]+=a.substr(d+1,f);return"+IPD,"+b[0]+","+(b[1]-f)+":"}var f,c=[],g=["","","","",""],k=0,m=["open","wep","wpa_psk","wpa2_psk","wpa_wpa2_psk"],p={create:function(a,d){if(void 0===a){var b=5;c[b]="Wait";g[b]="";f.cmd("AT+CIPSERVER=1,"+d+"\r\n",1E4,function(a){if("OK"==a)c[b]=!0;else throw c[b]=void 0,
Error("CIPSERVER failed");});return 5}for(b=0;void 0!==c[b];)b++;if(5<=b)throw Error("No free sockets");c[b]="Wait";g[b]="";f.cmd("AT+CIPSTART="+b+',"TCP",'+JSON.stringify(a)+","+d+"\r\n",1E4,function(a){"OK"==a?f.registerLine("Linked",function(){f.unregisterLine("Linked");c[b]=!0}):c[b]=void 0});return b},close:function(a){"Wait"==c[a]?c[a]="WaitClose":(k=a,f.cmd((5==a?"AT+CIPSERVER=0":"AT+CIPCLOSE="+a)+"\r\n",1E3,function(d){c[a]=void 0}))},accept:function(a){for(a=0;5>a;a++)if(g[a]&&void 0===c[a])return c[a]=
!0,a;return-1},recv:function(a,d){if(g[a]){if(g[a].length>d){var b=g[a].substr(0,d);g[a]=g[a].substr(d)}else b=g[a],g[a]="";return b}return c[a]?"":-1},send:function(a,d){if(f.isBusy()||"Wait"==c[a])return 0;if(!c[a])return-1;f.register("> ",function(){f.unregister("> ");f.write(d);return""});c[a]="Wait";k=a;f.cmd("AT+CIPSEND="+a+","+d.length+"\r\n",1E4,function(b){"SEND OK"==b?("WaitClose"==c[a]&&p.close(a),c[a]=!0):(c[a]=void 0,f.unregister("> "))});return d.length}},l={ipdHandler:n,debug:function(){return{socks:c,
sockData:g}},init:function(a){f.cmd("ATE0\r\n",1E3,function b(c){if("ATE0"==c)return b;"OK"==c?f.cmd("AT+CIPMUX=1\r\n",1E3,function(b){"OK"!=b?a("CIPMUX failed: "+b):a(null)}):a("ATE0 failed: "+c)})},reset:function(a){f.cmd("\r\nAT+RST\r\n",1E4,function b(f){if("ready"==f)setTimeout(function(){l.init(a)},1E3);else if(void 0===f)a("No 'ready' after AT+RST");else return b})},getVersion:function(a){f.cmd("AT+GMR\r\n",1E3,function(d){a(null,d)})},connect:function(a,d,b){f.cmd("AT+CWMODE=1\r\n",1E3,function(c){"no change"!=
c&&"OK"!=c?b("CWMODE failed: "+c):f.cmd("AT+CWJAP="+JSON.stringify(a)+","+JSON.stringify(d)+"\r\n",2E4,function(a){"OK"!=a?b("WiFi connect failed: "+a):b(null)})})},getAPs:function(a){var d=[];f.cmdReg("AT+CWLAP\r\n",5E3,"+CWLAP:",function(a){a=a.slice(8,-1).split(",");d.push({ssid:JSON.parse(a[1]),enc:m[a[0]],signal:parseInt(a[2]),mac:JSON.parse(a[3])})},function(b){a(null,d)})},getConnectedAP:function(a){var d;f.cmdReg("AT+CWJAP?\r\n",1E3,"+CWJAP:",function(a){d=JSON.parse(a.slice(7))},function(b){a(null,
d)})},createAP:function(a,d,b,c,g){f.cmd("AT+CWMODE=2\r\n",1E3,function(h){"no change"!=h&&"OK"!=h&&g("CWMODE failed: "+h);h=c?m.indexOf(c):0;0>h?g("Encryption type "+c+" not known - "+m):f.cmd("AT+CWSAP="+JSON.stringify(a)+","+JSON.stringify(d)+","+b+","+h+"\r\n",5E3,function(a){"OK"!=a?g("CWSAP failed: "+a):g(null)})})},getConnectedDevices:function(a){var d=[];this.at.cmd("AT+CWLIF\r\n",1E3,function q(c){if("OK"==c)a(null,d);else if(void 0===c||"ERROR"==c)a("Error");else return e=c.split(","),d.push({ip:e[0],
mac:e[1]}),q})},getIP:function(a){f.cmd("AT+CIFSR\r\n",1E3,function(c){return function(b){return"OK"!=b?a("CIFSR failed: "+b):a(null,c)}})}};exports.connect=function(a,d){l.at=f=require("AT").connect(a);require("NetworkJS").create(p);f.register("+IPD",n);f.registerLine("Unlink",function(){c[k]=void 0});l.reset(d);return l}